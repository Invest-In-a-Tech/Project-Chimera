# Log — 2025-11-05

## Session: Order Flow Indicators Integration - Volume Delta and Large Trades

### Overview
Added critical order flow indicators to the VBP data pipeline. This session focused on integrating Study ID 2 (Volume Delta indicators) and enhancing the display of Study ID 9 (Large Trades) to provide comprehensive institutional and order flow analysis. These indicators are essential for understanding market sentiment, directional bias, and identifying smart money activity.

---

## Major Changes

### 1. Added Study ID 2 to Data Fetching Modules

**Updated Modules:**
- `src/sc_py_bridge/subscribe_to_vbp_chart_data.py` - Real-time subscription module
- `src/sc_py_bridge/get_vbp_chart_data.py` - Historical data fetching module

**Study ID 2 Configuration:**
```python
# Study ID 2: Volume Delta - tracks net buying/selling pressure
# Subgraph 1: Delta - Ask volume minus Bid volume difference
# Subgraph 10: Cumulative Delta - running total of net volume delta
SubgraphQuery(study_id=2, subgraphs=[1, 10])
```

**Why This Matters:**
- **Delta**: Shows net buying (+) or selling (-) pressure for each individual bar
- **Cumulative Delta**: Running total that reveals longer-term directional bias
- These indicators help identify:
  - Accumulation/distribution phases
  - Divergences between price and order flow
  - Institutional positioning
  - Potential reversal zones

### 2. Column Naming Standardization

**Corrected Naming Convention:**
- ~~`CVD` (Cumulative Volume Delta)~~ → `Delta` (per-bar net volume)
- Added: `CumulativeDelta` (running total)
- Standardized Large Trades: `LargeBidTrade` and `LargeAskTrade`

**Rationale:**
- Study ID 2, Subgraph 1 is the **Delta** (not CVD)
- Study ID 2, Subgraph 10 is the **Cumulative Delta** (the actual CVD)
- Study ID 9, Subgraphs 3 & 4 renamed for clarity and consistency
- Proper naming prevents confusion and aligns with Sierra Chart terminology

**Column Mappings Added:**
```python
'ID2.SG1': 'Delta',            # Net volume for this bar
'ID2.SG10': 'CumulativeDelta'  # Running total of net volume
'ID9.SG3': 'LargeBidTrade'     # Large trades on bid side (selling pressure)
'ID9.SG4': 'LargeAskTrade'     # Large trades on ask side (buying pressure)
```

### 3. Display Integration in Live Mode

**Updated `main.py` Bar-Level Display:**

### 3. Enhanced Bar-Level Display with Institutional Order Flow

**Updated `main.py` Bar-Level Display:**

Added comprehensive order flow indicators to the real-time display output in two locations:
1. Initial historical data display (line ~435)
2. Real-time update loop display (line ~523)

**Complete Bar-Level Indicators:**
- **OHLCV**: Standard price/volume data
- **RVOL**: Relative volume indicator
- **Delta**: Net buying/selling pressure per bar
- **CumulativeDelta**: Running total of net volume delta
- **LargeBidTrade**: Large institutional selling pressure ✨ NEW
- **LargeAskTrade**: Large institutional buying pressure ✨ NEW

**Example Output:**
```
================================================================================
UPDATE #15 - 2025-11-05 14:45:00
================================================================================
Processed 12 granular rows (price levels)

Bar Data (OHLCV):
  Open:   5825.25
  High:   5826.50
  Low:    5824.75
  Close:  5825.75
  Volume: 1450
  RVOL:   1.23
  Delta:  245              # Net buying pressure this bar
  CumDelta: 1820           # Running total - bullish bias
  LargeBidTrade: 350       # Institutional selling
  LargeAskTrade: 595       # Institutional buying
```

**Display Format:**
- `Delta`: Integer format (e.g., 245) - shows immediate bar sentiment
- `CumDelta`: Integer format (e.g., 1820) - shows cumulative position
- `LargeBidTrade`: Integer format (e.g., 350) - large sell orders
- `LargeAskTrade`: Integer format (e.g., 595) - large buy orders

**Why Large Trades Matter:**
- Identifies institutional activity and smart money positioning
- Large bid trades = institutional selling (bearish signal)
- Large ask trades = institutional buying (bullish signal)
- Imbalance between bid/ask large trades reveals directional bias
- Helps distinguish retail vs. institutional activity

---

## Technical Details

### Files Modified

1. **`src/sc_py_bridge/subscribe_to_vbp_chart_data.py`**
   - Line ~361: Updated `SubgraphQuery(study_id=2, subgraphs=[1, 10])`
   - Line ~585-589: Renamed large trade columns: `LargeBidTrade`, `LargeAskTrade`
   - Line ~591-595: Added column mappings for Delta and CumulativeDelta

2. **`src/sc_py_bridge/get_vbp_chart_data.py`**
   - Line ~295: Updated `SubgraphQuery(study_id=2, subgraphs=[1, 10])`
   - Line ~523-527: Renamed large trade columns: `LargeBidTrade`, `LargeAskTrade`
   - Line ~529-533: Added column mappings for Delta and CumulativeDelta

3. **`main.py`**
   - Line ~435: Added Delta, CumDelta, LargeBidTrade, LargeAskTrade to initial display
   - Line ~523: Added Delta, CumDelta, LargeBidTrade, LargeAskTrade to real-time display
   - Updated comments to explain institutional order flow indicators
   - Line ~529: Added column mappings for Delta and CumulativeDelta

3. **`main.py`**
   - Line ~433: Added Delta and CumDelta to initial display
   - Line ~517: Added Delta and CumDelta to real-time update display
   - Updated comments to explain both indicators

### Processing Pipeline

**Data Flow:**
```
Sierra Chart (Study ID 2 + Study ID 9)
    ↓
SCBridge (Raw DTC Protocol)
    ↓
Response Processor (VBP DataFrame)
    ↓
Column Renaming:
  - ID2.SG1 → Delta
  - ID2.SG10 → CumulativeDelta
  - ID9.SG3 → LargeBidTrade
  - ID9.SG4 → LargeAskTrade
    ↓
Data Pipeline (Feature Engineering)
    ↓
Sequential Processor (Granular Processing)
    ↓
Live Display (Bar-Level Metrics)
```

**Key Characteristics:**
- **All are bar-level indicators** (same value for all price levels in a bar)
- **Delta**: Resets each bar (can be positive or negative)
- **CumulativeDelta**: Cumulative (tracks net flow across all bars)
- **LargeBidTrade**: Institutional selling pressure per bar
- **LargeAskTrade**: Institutional buying pressure per bar
- All displayed as integers (volume units)

---

## Order Flow Analysis Use Cases

### 1. Delta Divergence Detection
```python
# Example: Price makes new high but CumulativeDelta doesn't
if current_price > previous_high and cumulative_delta < previous_cumulative_delta:
    # Bearish divergence - weak buying despite higher prices
    signal = "potential_reversal_down"
```

### 2. Institutional Activity Detection
```python
# Example: Large trades show institutional accumulation
if large_ask_trade > large_bid_trade * 1.5 and delta > 0:
    # Strong institutional buying pressure
    signal = "smart_money_accumulation"
elif large_bid_trade > large_ask_trade * 1.5 and delta < 0:
    # Strong institutional selling pressure
    signal = "smart_money_distribution"
```

### 3. Accumulation/Distribution
```python
# Example: Strong buying despite sideways price action
if price_range < threshold and delta > positive_threshold:
    # Accumulation phase - smart money buying
    signal = "accumulation"
```

### 3. Momentum Confirmation
```python
# Example: Price breakout with strong order flow
if price_breakout and cumulative_delta_trend > 0 and delta > threshold:
    # Confirmed breakout with institutional support
    signal = "strong_breakout"
```

---

## Data Structure

### DataFrame Schema (After Processing)

**Bar-Level Columns (Same for all price levels in a bar):**
- `Open`, `High`, `Low`, `Close` - OHLC price data
- `Volume` - Total bar volume
- `RVOL` - Relative volume (Study ID 6)
- `TodayOpen`, `TodayHigh`, `TodayLow` - Session levels (Study ID 4)
- `LTMaxVol`, `LTTotalVol` - Large trades aggregates (Study ID 9)
- **`LargeBidTrade`** - Institutional selling pressure (Study ID 9, Subgraph 3) ✨ RENAMED
- **`LargeAskTrade`** - Institutional buying pressure (Study ID 9, Subgraph 4) ✨ RENAMED
- **`Delta`** - Net volume this bar (Study ID 2, Subgraph 1) ✨ NEW
- **`CumulativeDelta`** - Running total (Study ID 2, Subgraph 10) ✨ NEW

**Price-Level Columns (Unique per price level):**
- `Price` - Price level
- `BidVol` - Volume at bid
- `AskVol` - Volume at ask
- `TotalVolume` - Total volume at this price
- `NumOfTrades` - Number of trades at this price

---

## Testing & Verification

### Verification Steps:
1. ✅ Study ID 2 successfully added to both subscription and historical fetch modules
2. ✅ Column naming corrected (CVD → Delta)
3. ✅ CumulativeDelta (Subgraph 10) added to both modules
4. ✅ Large trade columns renamed for clarity (LargeBidTrade, LargeAskTrade)
5. ✅ Display integration in main.py (both initial and live sections)
6. ✅ All order flow indicators (Delta, CumulativeDelta, LargeBidTrade, LargeAskTrade) displayed
5. ✅ All modules updated consistently

### Next Steps:
1. Run live mode to verify data streams correctly: `uv run main.py process-data --mode live`
2. Validate Delta, CumulativeDelta, and Large Trade values against Sierra Chart display
3. Test institutional activity detection logic using LargeBidTrade vs LargeAskTrade imbalances
4. Implement divergence detection logic in feature engineering pipeline
5. Consider adding order flow-based alerts:
   - Unusual Delta imbalances (e.g., |Delta| > 2 * RVOL * AvgVolume)
   - Large trade imbalances signaling institutional positioning
   - CumulativeDelta trend reversals

---

## Lessons Learned

### Naming Conventions Matter
- Sierra Chart's Study ID 2 uses "Delta" not "CVD" for Subgraph 1
- Renamed Study ID 9 subgraphs for clarity: `LargeBidTrade`, `LargeAskTrade`
- Proper terminology prevents confusion during analysis
- Always verify indicator names against source documentation
- Consistency across modules is critical for maintainability

### Modular Architecture Pays Off
- Changes required updates to only 3 files (2 bridge modules + main.py)
- Separation of concerns made additions straightforward
- Consistent patterns across subscription and historical modules

### Display Design
- Bar-level indicators shown once (not repeated for each price level)
- Integer format appropriate for volume-based metrics
- Abbreviated "CumDelta" saves space while remaining clear

---

## Future Enhancements

### Potential Additions:
1. **Delta Rate of Change**: Acceleration/deceleration of order flow
2. **Delta Divergence Alerts**: Automated detection of price/flow divergences
3. **Delta Percentile**: Compare current delta to historical distribution
4. **Session Delta Reset**: Track cumulative delta within trading sessions only
5. **Delta Volume Profile**: Visualize delta distribution across price levels

### Feature Engineering Ideas:
- `delta_ema`: Exponential moving average of delta for trend
- `delta_to_volume_ratio`: Normalize delta by bar volume
- `cumulative_delta_slope`: Rate of change in cumulative delta
- `delta_reversal_signal`: Extreme delta values signaling exhaustion

---

## References

- **Sierra Chart Study ID 2**: Volume Delta
  - Subgraph 1: Delta (bar net volume)
  - Subgraph 10: Cumulative Delta (running total)
- **Trade29 SC Bridge**: `SubgraphQuery` for study data retrieval
- **Project Architecture**: See `docs/setup/live-mode-architecture.md`

---

## Summary

Successfully integrated Volume Delta and Cumulative Delta indicators into the entire data pipeline. These order flow metrics provide critical insight into market sentiment and institutional positioning. The implementation is consistent across both real-time subscription and historical data fetching, with proper display integration in live mode.

**Key Achievement**: Complete order flow indicator suite now available for feature engineering and model training, enabling advanced order flow-based trading strategies.
